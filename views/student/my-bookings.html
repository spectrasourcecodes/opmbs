<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Bookings - Library Portal</title>
    <link rel="stylesheet" href="styles/my-bookings.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>My Bookings</h2>
            <div class="user-info">
                <div class="user-avatar"><%= userInitials %></div>
                <div>
                    <div><strong><%= userName %></strong></div>
                    <small>Member since <%= joinDate %></small>
                </div>
            </div>
        </div>
        
        <div class="tabs">
            <div class="tab active" data-tab="current">Current Bookings</div>
            <div class="tab" data-tab="history">Booking History</div>
        </div>
        
        <div class="tab-content active" id="current-bookings">
            <% if (currentBookings.length > 0) { %>
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">Currently Checked Out (<%= currentBookings.length %>)</h4>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Manual Title</th>
                                    <th>Checkout Date</th>
                                    <th>Due Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% currentBookings.forEach(booking => { 
                                    const dueDate = new Date(booking.due_date);
                                    const today = new Date();
                                    const timeDiff = dueDate.getTime() - today.getTime();
                                    const daysRemaining = Math.ceil(timeDiff / (1000 * 3600 * 24));
                                %>
                                <tr>
                                    <td><%= booking.manual_title %></td>
                                    <td><%= new Date(booking.checkout_date).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) %></td>
                                    <td><%= new Date(booking.due_date).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) %></td>
                                    <td>
                                        <span class="badge <%= daysRemaining < 3 ? (daysRemaining >= 0 ? 'bg-warning' : 'bg-danger') : 'bg-success' %>">
                                            <%= daysRemaining >= 0 ? `${daysRemaining} days remaining` : `${Math.abs(daysRemaining)} days overdue` %>
                                        </span>
                                    </td>
                                    <td>
                                        <% if (daysRemaining >= 0) { %>
                                        <button class="btn btn-primary btn-sm renew-btn" data-booking-id="<%= booking.id %>">
                                            Renew
                                        </button>
                                        <% } %>
                                        <button class="btn btn-secondary btn-sm details-btn" data-manual-id="<%= booking.manual_id %>">
                                            Details
                                        </button>
                                    </td>
                                </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <% } else { %>
            <div class="card">
                <div class="no-bookings">
                    <div>ðŸ“š</div>
                    <h3>No Current Bookings</h3>
                    <p>You don't have any manuals checked out at the moment.</p>
                    <a href="browse-manual.html" class="btn btn-primary">Browse Manuals</a>
                </div>
            </div>
            <% } %>
        </div>
        
        <div class="tab-content" id="booking-history">
            <% if (pastBookings.length > 0) { %>
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">Booking History</h4>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Manual Title</th>
                                    <th>Checkout Date</th>
                                    <th>Return Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% pastBookings.forEach(booking => { %>
                                <tr>
                                    <td><%= booking.manual_title %></td>
                                    <td><%= new Date(booking.checkout_date).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) %></td>
                                    <td><%= booking.return_date ? new Date(booking.return_date).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) : '--' %></td>
                                    <td>
                                        <span class="badge <%= booking.status === 'Returned' ? 'bg-success' : 'bg-danger' %>">
                                            <%= booking.status %>
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-secondary btn-sm details-btn" data-manual-id="<%= booking.manual_id %>">
                                            Details
                                        </button>
                                        <% if (booking.status === 'Returned') { %>
                                        <button class="btn btn-primary btn-sm review-btn" data-manual-id="<%= booking.manual_id %>">
                                            Leave Review
                                        </button>
                                        <% } %>
                                    </td>
                                </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <% } else { %>
            <div class="card">
                <div class="no-bookings">
                    <div>ðŸ“–</div>
                    <h3>No Booking History</h3>
                    <p>Your past bookings will appear here once you return some manuals.</p>
                </div>
            </div>
            <% } %>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(`${tabId}-bookings`).classList.add('active');
                });
            });
            
            // Renew button handler
            document.querySelectorAll('.renew-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const bookingId = this.getAttribute('data-booking-id');
                    if (confirm('Are you sure you want to renew this booking for another week?')) {
                        window.location.href = `/renew-booking?id=${bookingId}`;
                    }
                });
            });
            
            // Details button handler
            document.querySelectorAll('.details-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const manualId = this.getAttribute('data-manual-id');
                    window.location.href = `/manual-details?id=${manualId}`;
                });
            });
            
            // Review button handler
            document.querySelectorAll('.review-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const manualId = this.getAttribute('data-manual-id');
                    window.location.href = `/leave-review?manual_id=${manualId}`;
                });
            });
        });
    </script>
</body>
</html>